<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Renderer Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container mt-4">
        <h1>Canvas Renderer Test</h1>
        
        <div class="row">
            <div class="col-8">
                <div class="canvas-container bg-white border rounded p-3">
                    <canvas id="annotation-canvas" class="border"></canvas>
                </div>
            </div>
            <div class="col-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <button id="load-image-btn" class="btn btn-primary mb-2">Load Test Image</button>
                        <button id="add-annotation-btn" class="btn btn-success mb-2">Add Test Annotation</button>
                        <button id="clear-annotations-btn" class="btn btn-warning mb-2">Clear Annotations</button>
                        <button id="test-coordinates-btn" class="btn btn-info mb-2">Test Coordinates</button>
                        <div id="test-output" class="mt-3">
                            <small class="text-muted">Test output will appear here...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { CONFIG } from './config.js';
        import { CanvasRenderer } from './js/canvas-renderer.js';

        // Initialize canvas renderer
        const canvas = document.getElementById('annotation-canvas');
        const container = document.querySelector('.canvas-container');
        const renderer = new CanvasRenderer(canvas, container);
        
        // Test output element
        const output = document.getElementById('test-output');
        
        function log(message) {
            console.log(message);
            output.innerHTML += '<div class="small">' + message + '</div>';
        }

        // Test image loading
        document.getElementById('load-image-btn').addEventListener('click', () => {
            log('Loading test image...');
            
            const img = new Image();
            img.onload = () => {
                log(`Image loaded: ${img.width}x${img.height}`);
                const success = renderer.drawImage(img);
                log(`Image drawn: ${success}`);
                
                const info = renderer.getImageInfo();
                if (info) {
                    log(`Scaled to: ${info.scaledWidth.toFixed(1)}x${info.scaledHeight.toFixed(1)} (scale: ${info.scale.toFixed(3)})`);
                }
            };
            img.onerror = () => {
                log('Failed to load image');
            };
            img.src = CONFIG.SAMPLE_IMAGES[0];
        });

        // Test annotation adding
        document.getElementById('add-annotation-btn').addEventListener('click', () => {
            const testAnnotation = {
                id: 'test_' + Date.now(),
                bbox: {
                    x: 50 + Math.random() * 200,
                    y: 50 + Math.random() * 200,
                    width: 100 + Math.random() * 100,
                    height: 80 + Math.random() * 80
                },
                className: ['Car', 'Truck', 'Bus', 'Person'][Math.floor(Math.random() * 4)],
                confidence: 0.7 + Math.random() * 0.3,
                state: ['Suggested', 'Modified', 'Verified'][Math.floor(Math.random() * 3)],
                createdAt: new Date()
            };
            
            renderer.addAnnotation(testAnnotation);
            log(`Added annotation: ${testAnnotation.className} (${testAnnotation.state})`);
        });

        // Test clearing annotations
        document.getElementById('clear-annotations-btn').addEventListener('click', () => {
            renderer.setAnnotations([]);
            log('Cleared all annotations');
        });

        // Test coordinate transformations
        document.getElementById('test-coordinates-btn').addEventListener('click', () => {
            log('Testing coordinate transformations...');
            
            // Test canvas to image coordinates
            const canvasPoint = { x: 100, y: 100 };
            const imagePoint = renderer.canvasToImageCoordinates(canvasPoint.x, canvasPoint.y);
            const backToCanvas = renderer.imageToCanvasCoordinates(imagePoint.x, imagePoint.y);
            
            log(`Canvas (${canvasPoint.x}, ${canvasPoint.y}) -> Image (${imagePoint.x.toFixed(1)}, ${imagePoint.y.toFixed(1)}) -> Canvas (${backToCanvas.x.toFixed(1)}, ${backToCanvas.y.toFixed(1)})`);
            
            // Test point in image
            const inImage = renderer.isPointInImage(canvasPoint.x, canvasPoint.y);
            log(`Point (${canvasPoint.x}, ${canvasPoint.y}) in image: ${inImage}`);
        });

        // Test canvas click for annotation selection
        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const canvasX = event.clientX - rect.left;
            const canvasY = event.clientY - rect.top;
            
            const annotation = renderer.getAnnotationAtPoint(canvasX, canvasY);
            
            if (annotation) {
                renderer.highlightAnnotation(annotation.id);
                log(`Clicked annotation: ${annotation.className} (${annotation.id})`);
            } else {
                renderer.clearSelection();
                log(`Clicked empty area at (${canvasX.toFixed(1)}, ${canvasY.toFixed(1)})`);
            }
        });

        // Initial setup
        log('Canvas Renderer Test initialized');
        log('Canvas size: ' + canvas.width + 'x' + canvas.height);
        
        // Auto-resize canvas
        renderer.resizeCanvas();
        
        window.testRenderer = renderer;
    </script>
</body>
</html>